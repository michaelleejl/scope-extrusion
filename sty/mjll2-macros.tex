\newcommand{\function}[2]{\lambda{} #1. #2}
\newcommand{\continuation}[2]{\kappa{} #1. #2}

\newcommand{\Nat}[1]{\texttt{Nat}(#1)}
\newcommand{\Var}[2]{\texttt{Var}(#1_{#2})}
\newcommand{\Binder}[2]{\texttt{\underline{Var}}(#1_{#2})}

\newcommand{\Lam}[2]{\texttt{Lam}(#1, #2)}
\newcommand{\App}[2]{\texttt{App}(#1, #2)}
\newcommand{\Ret}[1]{\texttt{Ret}(#1)}
\newcommand{\Do}[3]{\texttt{Do}(#1, #2, #3)}
\newcommand{\Op}[1]{\texttt{Op}(#1)}
\newcommand{\Continue}[2]{\texttt{Continue}(#1, #2)}
\newcommand{\Hwith}[2]{\texttt{Hwith}(#1, #2)}
\newcommand{\Hret}[2]{\texttt{Hret}(#1, #2)}
\newcommand{\Hop}[4]{\texttt{Hop}(#1, #2, #3, #4)}
\newcommand{\err}[0]{\texttt{\textbf{err}}}

\newcommand{\return}[1]{\texttt{\textbf{return}} \,\, {#1}}
\newcommand{\op}[1]{\textbf{\texttt{op}}({#1})}
\newcommand{\bind}[3]{\texttt{\textbf{do}} \,\, {#1} \leftarrow {#2} \; \textbf{\texttt{in}} \; {#3}}
\newcommand{\handleWith}[2]{\textbf{\texttt{handle}} \,\, {#1} \,\, \textbf{\texttt{with}} \,\, \{{#2}\}}
\newcommand{\continue}[2]{\textbf{\texttt{continue}} \, {#1} \, {#2}}

\newcommand{\gensym}[1]{\textbf{\texttt{mkvar}} \, #1}
\newcommand{\varToAST}[1]{\textbf{\texttt{binderToAST}} \, #1}

\newcommand{\dlet}[2]{\textbf{\texttt{dlet}}({#1}, {#2})}
\newcommand{\checkfv}[1]{\textbf{\texttt{check}}\, {#1}}
\newcommand{\checkm}[1]{\textbf{\texttt{check}}_{M}\, {#1}}
\newcommand{\tls}[1]{\textbf{\texttt{tls}}({#1})}

\newcommand{\freevars}[1]{{\textsf{FV}}^0({#1})}
\newcommand{\projfvs}[1]{\pi_{\texttt{Var}}({#1})}

\newcommand{\returnHandler}[2]{\textbf{\texttt{return}}(#1) \mapsto #2}
\newcommand{\opHandler}[3]{\textbf{\texttt{op}}(#1, #2) \mapsto #3}

\newcommand{\evalContext}[0]{E[-]}
\newcommand{\variableFrame}[2]{V_{#1}(#2)}

\newcommand{\equote}[1][e]{\langle \langle #1 \rangle \rangle}
\newcommand{\splice}[1][e]{\$ #1 }

\newcommand{\effconfiguration}[2]{\langle {#1}, {#2} \rangle}
\newcommand{\transition}[2]{{#1} \leadsto {#2}}


\makeatletter
\newcommand{\oset}[3][0ex]{%
  \mathrel{\mathop{#3}\limits^{
    \vbox to#1{\kern-2\ex@
    \hbox{$\scriptstyle#2$}\vss}}}}
\makeatother

\makeatletter
% issue another \@doendpe and lift it out of the group
\patchcmd{\mint@iii}
  {\minted@langlinenosoff\endgroup}
  {\minted@langlinenosoff\endgroup\@doendpe}
  {}{}
\makeatother

\makeatletter
\tcbset{
  after app={%
    \ifx\tcb@drawcolorbox\tcb@drawcolorbox@breakable
    \else
      % add only when not breakabel
      \@endparenv
    \fi
  }
}

% for breakable
\appto\tcb@use@after@lastbox{\@endparenv\@doendpe}
\makeatother

\DeclareRobustCommand\longtwoheadrightarrow
     {\relbar\joinrel\twoheadrightarrow}

\newcommand{\type}[3][]{\Gamma #1 \vdash #2 : #3}
\newcommand{\effectType}[2][\Delta]{{#2} \, ! \, {#1}}
\newcommand{\functionType}[3][\Delta]{{#2} \oset{\text{\tiny ${#1}$}}{\longrightarrow} {#3}}
\newcommand{\handlerType}[2]{#1 \Longrightarrow #2}
\newcommand{\continuationType}[3][\Delta]{#2 \oset{\text{\tiny ${#1}$}}{\longtwoheadrightarrow} #3}

% \newcommand\xrsquigarrow[1]{%
% \mathrel{%
% \begin{tikzpicture}[baseline= {( $ (current bounding box.south) + (0,-0.5ex) $ )}]
%   \node[inner sep=.5ex] (a) {$\scriptstyle #1$};
%   \path[draw,implies-,double distance between line centers=1.5pt,decorate,
%     decoration={zigzag,amplitude=0.7pt,segment length=1.2mm,pre=lineto,
%     pre   length=4pt}] 
%     (a.south east) -- (a.south west);
% \end{tikzpicture}}%
% }
\mdfsetup{%
topline=false,
rightline=false,
bottomline=false,
linewidth=3pt,
innerleftmargin=15pt,
innerrightmargin=0pt,
skipabove=\baselineskip,
skipabove=1.2\baselineskip,
}

\renewtheorem{mdtheorem}{Theorem}[section]
\newenvironment{theorem}[2][]%
   {\vspace{0\baselineskip}\begin{mdframed}[linecolor=#2]\begin{mdtheorem}[#1]}
   {\end{mdtheorem}\end{mdframed}\par\vspace{\baselineskip}}

\newtheorem{mdcorollary}{Corollary}[section]
\newenvironment{corollary}[2][]%
  {\par\vspace{0\baselineskip}\begin{mdframed}[linecolor=#2]\begin{mdcorollary}[#1]}
  {\end{mdcorollary}\end{mdframed}\par\vspace{\baselineskip}}

\newtheorem{mddefinition}{Definition}[section]
\newenvironment{definition}[2][]%
    {\vspace{0\baselineskip}\begin{mdframed}[linecolor=#2]\begin{mddefinition}[#1]}
    {\end{mddefinition}\end{mdframed}\par\vspace{\baselineskip}}


    \newtheorem{mdlemma}{Lemma}[section]
\newenvironment{lemma}[2][]%
    {\vspace{0\baselineskip}\begin{mdframed}[linecolor=#2]\begin{mdlemma}[#1] 
    }
    {\end{mdlemma}\end{mdframed}\par\vspace{\baselineskip}}
  % \newenvironment{codeblock}[2][][]{
%     \begin{tcblisting}[
%         minted language=ocaml,
%         minted options={mathescape, linenos, \#2},
%         \#1
%     ]
% }
% {\end{tcblisting}}

% \newenvironment{ocaml}{\begin{codeblock}}{\end{codeblock}}

% \newtcblisting{ocaml-box}{
%     listing only
% }

% \newenvironment{code}[1]
%  {\VerbatimEnvironment
%   \begin{minted}{#1}}
%  {\end{minted}}

% \newenvironment{ocaml}{%
%     \begin{code}{ocaml}
% }{
%     \end{code} 
% }
% \newenvironment{macocaml}{\begin{code}{macocaml.py:MacocamlLexer}}{\end{code}}

\renewcommand{\theFancyVerbLine}{\ttfamily \textcolor[rgb]{0.5,0.5,0.5}{\footnotesize{\arabic{FancyVerbLine}}}}

\DeclarePairedDelimiter\Brackets{\lBrack}{\rBrack}

\makeatletter
\tcbset{common/.style={
    enhanced,
    left=5pt,
    listing only,
    colframe=white,
  },
  after app={%
    \ifx\tcb@drawcolorbox\tcb@drawcolorbox@breakable
    \else
      % add only when not breakabel
      \@endparenv
    \fi
  }
  \appto\tcb@use@after@lastbox{\@endparenv\@doendpe}
}
\makeatother

\newtcblisting{ocaml}{
  common,
  minted language=ocaml,
  colback=ocamlBackground,
  listing engine=minted,
  after={\par\vspace{0.2\baselineskip}\noindent},
  minted options = {linenos, fontsize=\footnotesize, numbersep=15pt, baselinestretch=1.1, escapeinside=``},
  overlay={\node[fill=ocamlHighlight,yshift=-9pt,xshift=-10pt,left,text=white,
         anchor=east,font=\footnotesize\ttfamily\bfseries] at (frame.north east){OCaml};}
%   skin=tile,
 }

 \newtcblisting{ocamllst}{
  common,
  minted language=ocaml,
  colback=ocamlBackground,
  listing engine=minted,
  % before={\par\vspace{0\baselineskip}\noindent},
  after={\par\vspace{0\baselineskip}\noindent},
  minted options = {linenos, fontsize=\footnotesize, numbersep=15pt, baselinestretch=1.1, escapeinside=``},
  overlay={\node[fill=ocamlHighlight,yshift=-9pt,xshift=-10pt,left,text=white,
         anchor=east,font=\footnotesize\ttfamily\bfseries] at (frame.north east){OCaml};}
%   skin=tile,
 }

 \newcommand{\macocamlLexer}{lexers/macocaml.py:MacocamlLexer}
 \newtcblisting{macocaml}{
  common,
  minted language=\macocamlLexer,
  colback=ocamlBackground,
  listing engine=minted,
  after={\par\vspace{0.2\baselineskip}\noindent},
  minted options = {linenos, fontsize=\footnotesize, numbersep=15pt, baselinestretch=1.1, escapeinside=``},
  overlay={\node[fill=ocamlHighlight,yshift=-9pt,xshift=-10pt,left,text=white,
         anchor=east,font=\footnotesize\ttfamily\bfseries] at (frame.north east){MacoCaml};}
%   skin=tile,
 }
 \newtcblisting{macocamllst}{
  common,
  minted language=\macocamlLexer,
  colback=ocamlBackground,
  listing engine=minted,
  % before={\par\vspace{0\baselineskip}\noindent},
  after={\par\vspace{0\baselineskip}\noindent},
  minted options = {linenos, fontsize=\footnotesize, numbersep=15pt, baselinestretch=1.1, escapeinside=``},
  overlay={\node[fill=ocamlHighlight,yshift=-9pt,xshift=-10pt,left,text=white,
         anchor=east,font=\footnotesize\ttfamily\bfseries] at (frame.north east){OCaml};}
%   skin=tile,
 }

 \newcommand{\efflang}{$\lambda_{\texttt{op}}$}
 \newcommand{\sourceLang}{$\lambda_{\equote[\texttt{op}]}$}
 \newcommand{\calculusName}{\sourceLang}
 \newcommand{\coreLang}{$\lambda_{\texttt{AST}(\texttt{op})}$}
 \newtcolorbox{eff-desc}{
  common,
  % minted language=lexers/macocaml.py:MacocamlLexer,
  colback=white,
  fontupper=\small,
  borderline north={0.5mm}{0mm}{effHighlight,line width=1pt},
borderline south={0.5mm}{0mm}{effHighlight,line width=1pt},
  overlay={\node[fill=effHighlight,yshift=-9pt,xshift=-10pt,left,text=white,
         anchor=east,font=\footnotesize\ttfamily\bfseries] at (frame.north east){$\mathbf{\lambda}_{\text{op}}$};}
%   skin=tile,
 }

 \newtcolorbox{eff}{
  common,
  % minted language=ocaml,
  colback=effBackground,
  fontupper=\linespread{1.1}\footnotesize,
  after={\par\vspace{0.2\baselineskip}\noindent},
  % listing engine=minted,
  % minted options = {linenos, fontsize=\footnotesize, numbersep=15pt, baselinestretch=1.1, escapeinside=!!},
  overlay={\node[fill=effHighlight,yshift=-10pt,xshift=-10pt,left,text=white,
         anchor=east,font=\footnotesize\ttfamily\bfseries] at (frame.north east){$\mathbf{\lambda}_{\text{op}}$};}
%   skin=tile,
 }

 \newtcolorbox{efflst}{
  common,
  % minted language=ocaml,
  colback=effBackground,
  fontupper=\linespread{1.1}\footnotesize,
  after={\par\vspace{0\baselineskip}\noindent},
  % listing engine=minted,
  % minted options = {linenos, fontsize=\footnotesize, numbersep=15pt, baselinestretch=1.1, escapeinside=!!},
  overlay={\node[fill=effHighlight,yshift=-10pt,xshift=-10pt,left,text=white,
         anchor=east,font=\footnotesize\ttfamily\bfseries] at (frame.north east){$\mathbf{\lambda}_{\text{op}}$};}
%   skin=tile,
 }

 \newtcolorbox{source}{
  common,
  % minted language=ocaml,
  colback=sourceBackground,
  fontupper=\linespread{1.1}\footnotesize,
  after={\par\vspace{0.2\baselineskip}\noindent},
  % listing engine=minted,
  % minted options = {linenos, fontsize=\footnotesize, numbersep=15pt, baselinestretch=1.1, escapeinside=!!},
  overlay={\node[fill=sourceHighlight,yshift=-10pt,xshift=-10pt,left,text=white,
         anchor=east,font=\footnotesize\ttfamily\bfseries] at (frame.north east){\sourceLang{}};}
%   skin=tile,
 }

  \newtcolorbox{sourcelst}{
  common,
  % minted language=ocaml,
  colback=sourceBackground,
  fontupper=\linespread{1.1}\footnotesize,
  after={\par\vspace{0\baselineskip}\noindent},
  % listing engine=minted,
  % minted options = {linenos, fontsize=\footnotesize, numbersep=15pt, baselinestretch=1.1, escapeinside=!!},
  overlay={\node[fill=sourceHighlight,yshift=-10pt,xshift=-10pt,left,text=white,
         anchor=east,font=\footnotesize\ttfamily\bfseries] at (frame.north east){\sourceLang{}};}
%   skin=tile,
 }


 \newtcolorbox{source-desc}{
  common,
  % minted language=lexers/macocaml.py:MacocamlLexer,
  colback=white,
  fontupper=\small,
  borderline north={0.5mm}{0mm}{sourceHighlight,line width=1pt},
borderline south={0.5mm}{0mm}{sourceHighlight,line width=1pt},
  overlay={\node[fill=sourceHighlight,yshift=-10pt,xshift=-10pt,left,text=white,
         anchor=east,font=\footnotesize\ttfamily\bfseries] at (frame.north east){\sourceLang{}};}
%   skin=tile,
 }

  \newtcolorbox{core-desc}{
  common,
  % minted language=lexers/macocaml.py:MacocamlLexer,
  colback=white,
  fontupper=\small,
  borderline north={0.5mm}{0mm}{coreHighlight,line width=1pt},
borderline south={0.5mm}{0mm}{coreHighlight,line width=1pt},
  overlay={\node[fill=coreHighlight,yshift=-10pt,xshift=-10pt,left,text=white,
         anchor=east,font=\footnotesize\ttfamily\bfseries] at (frame.north east){\coreLang{}};}
%   skin=tile,
 }

 \newtcolorbox{core}{
  common,
  % minted language=ocaml,
  colback=coreBackground,
  fontupper=\linespread{1.1}\footnotesize,
  after={\par\vspace{0.2\baselineskip}\noindent},
  % listing engine=minted,
  % minted options = {linenos, fontsize=\footnotesize, numbersep=15pt, baselinestretch=1.1, escapeinside=!!},
  overlay={\node[fill=coreHighlight,yshift=-10pt,xshift=-10pt,left,text=white,
         anchor=east,font=\footnotesize\ttfamily\bfseries] at (frame.north east){\coreLang{}};}
%   skin=tile,
 }

  \newtcolorbox{corelst}{
  common,
  % minted language=ocaml,
  colback=coreBackground,
  fontupper=\linespread{1.1}\footnotesize,
  after={\par\vspace{0\baselineskip}\noindent},
  % listing engine=minted,
  % minted options = {linenos, fontsize=\footnotesize, numbersep=15pt, baselinestretch=1.1, escapeinside=!!},
  overlay={\node[fill=coreHighlight,yshift=-10pt,xshift=-10pt,left,text=white,
         anchor=east,font=\footnotesize\ttfamily\bfseries] at (frame.north east){\coreLang{}};}
%   skin=tile,
 }

 \newenvironment{code}{\centering}{\par\vspace{0.6\baselineskip}}

 \makeatletter
\newcommand\colorwave[1][blue]{\bgroup \markoverwith{\lower3.5\p@\hbox{\sixly \textcolor{#1}{\char58}}}\ULon}
\font\sixly=lasy6 % does not re-load if already loaded, so no memory problem.
\makeatother
